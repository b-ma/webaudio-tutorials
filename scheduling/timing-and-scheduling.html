<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Timing and Scheduling | Web Audio Tutorials</title>
    <meta name="description" content="Set of tutorials on the Web Audio API">
    <link rel="preload stylesheet" href="/webaudio-tutorials/assets/style.a0f09f0f.css" as="style">
    
    <script type="module" src="/webaudio-tutorials/assets/app.1a71a994.js"></script>
    <link rel="preload" href="/webaudio-tutorials/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/webaudio-tutorials/assets/chunks/framework.9f45b8e0.js">
    <link rel="modulepreload" href="/webaudio-tutorials/assets/chunks/theme.ef006651.js">
    <link rel="modulepreload" href="/webaudio-tutorials/assets/scheduling_timing-and-scheduling.md.06659819.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-9d8abc1e><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-9d8abc1e data-v-7ad780c2><div class="VPNavBar has-sidebar" data-v-7ad780c2 data-v-f1abbc6e><div class="container" data-v-f1abbc6e><div class="title" data-v-f1abbc6e><div class="VPNavBarTitle has-sidebar" data-v-f1abbc6e data-v-2973dbb4><a class="title" href="/webaudio-tutorials/" data-v-2973dbb4><!--[--><!--]--><!----><!--[-->Web Audio Tutorials<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-f1abbc6e><div class="curtain" data-v-f1abbc6e></div><div class="content-body" data-v-f1abbc6e><!--[--><!--]--><div class="VPNavBarSearch search" data-v-f1abbc6e><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-f1abbc6e data-v-f732b5d0><span id="main-nav-aria-label" class="visually-hidden" data-v-f732b5d0>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/webaudio-tutorials/" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Home</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-f1abbc6e data-v-283b26e9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-283b26e9 data-v-3329432d data-v-1c29e291><span class="check" data-v-1c29e291><span class="icon" data-v-1c29e291><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-3329432d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-3329432d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-f1abbc6e data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ircam-ismm/webaudio-tutorials" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-16cf740a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-f1abbc6e data-v-8e87c032 data-v-aa8de344><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-aa8de344><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-aa8de344><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-aa8de344><div class="VPMenu" data-v-aa8de344 data-v-e42ed9b3><!----><!--[--><!--[--><!----><div class="group" data-v-8e87c032><div class="item appearance" data-v-8e87c032><p class="label" data-v-8e87c032>Appearance</p><div class="appearance-action" data-v-8e87c032><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-8e87c032 data-v-3329432d data-v-1c29e291><span class="check" data-v-1c29e291><span class="icon" data-v-1c29e291><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-3329432d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-3329432d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-8e87c032><div class="item social-links" data-v-8e87c032><div class="VPSocialLinks social-links-list" data-v-8e87c032 data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ircam-ismm/webaudio-tutorials" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-16cf740a><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-f1abbc6e data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-9d8abc1e data-v-9e669cc1><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-9e669cc1><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-9e669cc1><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-9e669cc1>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-9e669cc1 data-v-24251f6f><button data-v-24251f6f>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-9d8abc1e data-v-ee2efba5><div class="curtain" data-v-ee2efba5></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-ee2efba5><span class="visually-hidden" id="sidebar-aria-label" data-v-ee2efba5> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-ee2efba5><section class="VPSidebarItem level-0" data-v-ee2efba5 data-v-bd01e0d5><!----><div class="items" data-v-bd01e0d5><!--[--><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Introduction</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-ee2efba5><section class="VPSidebarItem level-0" data-v-ee2efba5 data-v-bd01e0d5><div class="item" role="button" tabindex="0" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><h2 class="text" data-v-bd01e0d5>First steps</h2><!----></div><div class="items" data-v-bd01e0d5><!--[--><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/first-steps/generalities.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Generalities about the Web</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/first-steps/setting-up-environment.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Setting up an environment</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/first-steps/simple-website.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Create a simple website</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-ee2efba5><section class="VPSidebarItem level-0" data-v-ee2efba5 data-v-bd01e0d5><div class="item" role="button" tabindex="0" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><h2 class="text" data-v-bd01e0d5>Basics</h2><!----></div><div class="items" data-v-bd01e0d5><!--[--><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/basics/web-audio-api-introduction.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Web Audio API - Introduction</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/basics/oscillators-and-audio-files.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Oscillators and audio files</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/basics/amplitude-modulation-synthesis.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Ampliture modulation</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/basics/encapsulating-logic.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Encapsulating logic</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/basics/reusable-feedback-delay.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Reusable feedback delay</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-ee2efba5><section class="VPSidebarItem level-0 has-active" data-v-ee2efba5 data-v-bd01e0d5><div class="item" role="button" tabindex="0" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><h2 class="text" data-v-bd01e0d5>Scheduling</h2><!----></div><div class="items" data-v-bd01e0d5><!--[--><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/scheduling/timing-and-scheduling.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Timing and Scheduling</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/scheduling/granular-synthesis.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Granular Synthesis</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/webaudio-tutorials/scheduling/step-sequencer.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Step Sequencer</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-9d8abc1e data-v-3cf691b6><div class="VPDoc has-sidebar has-aside" data-v-3cf691b6 data-v-a3c25e27><!--[--><!--]--><div class="container" data-v-a3c25e27><div class="aside" data-v-a3c25e27><div class="aside-curtain" data-v-a3c25e27></div><div class="aside-container" data-v-a3c25e27><div class="aside-content" data-v-a3c25e27><div class="VPDocAside" data-v-a3c25e27 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-cb998dce data-v-3a6c4994><div class="content" data-v-3a6c4994><div class="outline-marker" data-v-3a6c4994></div><div class="outline-title" role="heading" aria-level="2" data-v-3a6c4994>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-3a6c4994><span class="visually-hidden" id="doc-outline-aria-label" data-v-3a6c4994> Table of Contents for current page </span><ul class="root" data-v-3a6c4994 data-v-463da30f><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-a3c25e27><div class="content-container" data-v-a3c25e27><!--[--><!--]--><!----><main class="main" data-v-a3c25e27><div style="position:relative;" class="vp-doc _webaudio-tutorials_scheduling_timing-and-scheduling" data-v-a3c25e27><div><h1 id="timing-and-scheduling" tabindex="-1">Timing and Scheduling <a class="header-anchor" href="#timing-and-scheduling" aria-label="Permalink to &quot;Timing and Scheduling&quot;">​</a></h1><p>In this tutorial we will focus on one of the most important aspects of any audio application, that is how to organize events in time. More precisely, we will review the possibilities and possible limitations of functionnalities provided by the Web Audio API, and we will learn how these limitations can be mitigated by using a lookahead scheduler.</p><h3 id="related-documentation" tabindex="-1">Related documentation <a class="header-anchor" href="#related-documentation" aria-label="Permalink to &quot;Related documentation&quot;">​</a></h3><ul><li><a href="https://developer.mozilla.org/docs/Web/API/BaseAudioContext/currentTime" target="_blank" rel="noreferrer"><code>AudioContext.currentTime</code></a></li><li><a href="https://web.dev/articles/audio-scheduling" target="_blank" rel="noreferrer"><code>A tale of two clocks - C. Wilson</code></a></li></ul><h2 id="clocks-and-times" tabindex="-1">Clocks and times <a class="header-anchor" href="#clocks-and-times" aria-label="Permalink to &quot;Clocks and times&quot;">​</a></h2><p>As we have seen in previous tutorials, the Web Audio API already provides us a clock and some ways of controlling some timing aspects over playback and synthesis.</p><p>Let&#39;s first consider the clock provided by the Web Audio API:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> now </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.currentTime;</span></span></code></pre></div><p>The <code>currentTime</code> attribute of the <code>AudioContext</code> gives us the time in seconds since the <code>AudioContext</code> has been resumed. This clock is computed as: <code>number of samples / sample rate</code> and is therefore accurate in terms of audio time.</p><p>However, it has one major limitation: it is re-computed once at each block of processing (i.e. at block rate or <code>k-rate</code>) or every 128 samples. For example, at 44.1kHz this means that it will advance by steps of <code>128 / 44100</code> seconds or ~2.9 milliseconds. In pracitcal terms this means that accessing <code>audioContext.currentTime</code> will always give you the time of the next block that will be computed.</p><p>In terms of scheduling, we have already seen different methods that allow us to achieve such thing. For example we can <code>start</code> and <code>stop</code> sources at a given time:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> src </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.</span><span style="color:#A6E22E;">createBufferSourceNode</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">src.buffer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> buffer;</span></span>
<span class="line"><span style="color:#F8F8F2;">src.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(audioContext.destination);</span></span>
<span class="line"><span style="color:#88846F;">// start the source in 1 sec and stop it in 3 seconds from now</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> now </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.currentTime;</span></span>
<span class="line"><span style="color:#F8F8F2;">src.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">(now </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">src.</span><span style="color:#A6E22E;">stop</span><span style="color:#F8F8F2;">(now </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">3</span><span style="color:#F8F8F2;">);</span></span></code></pre></div><p>Additionally, all automations methods of <code>AudioParams</code> can be scheduled in a similar way:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> envelop </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.</span><span style="color:#A6E22E;">createGain</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">envelop.gain.value </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">; </span><span style="color:#88846F;">// set the gain default value to 0</span></span>
<span class="line"><span style="color:#88846F;">// create an envelop that will start in 1 second and end in 3 seconds</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> now </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.currentTime;</span></span>
<span class="line"><span style="color:#F8F8F2;"> </span><span style="color:#88846F;">// create at start automation point</span></span>
<span class="line"><span style="color:#F8F8F2;">envelop.</span><span style="color:#A6E22E;">setValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">, now </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;"> </span><span style="color:#88846F;">// ramp linearly to 1 in 20 ms</span></span>
<span class="line"><span style="color:#F8F8F2;">envelop.</span><span style="color:#A6E22E;">linearRampToValueValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">, now </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0.02</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#88846F;">// ramp exponetialy to (almost) 0 at second 3 after now</span></span>
<span class="line"><span style="color:#F8F8F2;">envelop.</span><span style="color:#A6E22E;">exponentialRampToValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">0.001</span><span style="color:#F8F8F2;">, now </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">3</span><span style="color:#F8F8F2;">);</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>The <code>exponentialRampToValueAtTime</code> will throw an <code>Error</code> if it&#39;s target value is 0, because it is undefined mathematically. A practical way of finding a good value is to remember that this correspondance betwen linear and dB values:</p><ul><li>1 -&gt; 0 dB</li><li>0.1 -&gt; -20dB</li><li>0.01 -&gt; -40dB</li><li>0.001 -&gt; -60dB</li><li>... In the example above, this means that the target we set correspond to -80 dB which low enough so that tha corresponding source can be stop without earing any discontinuity.</li></ul></div><p>All these methods are indeed very practical and powerfull, as they allow us to schedule events, for example a metronome, very precisely at the sub sample level:</p><p><img src="/webaudio-tutorials/assets/fixed-scheduling.50c5c3d6.png" alt="fixed-scheduling"></p><p>However, such approach suffers one major limitation: we have to know every single event that will occur in our score (or application) to schedule them all at once in a very precise way. Indeed, this is not very suited for more interactive or reactive applications.</p><h2 id="principles-of-a-lookahead-scheduler" tabindex="-1">Principles of a lookahead scheduler <a class="header-anchor" href="#principles-of-a-lookahead-scheduler" aria-label="Permalink to &quot;Principles of a lookahead scheduler&quot;">​</a></h2><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The concepts presented in this section are mostly a digest af the article <a href="https://web.dev/articles/audio-scheduling" target="_blank" rel="noreferrer">&quot;A Tale of two Clocks&quot; by Chris Wilson</a>. We highly recommend you to read this article and come back to the tutorial afterwards.</p></div><p>To workaround this limitation, one possible way is two periodically check if what have things to schedule in the near future (the &quot;lookahead&quot;) until we check it again. As such, it becomes possible to react to external events such as a change of tempo:</p><p><img src="/webaudio-tutorials/assets/naive-lookahead.1a4da25b.png" alt="naive-lookahead"></p><p>Which we could write in (pseudo) JavaScript code:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> lookahead </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0.1</span><span style="color:#F8F8F2;">; </span><span style="color:#88846F;">// in second</span></span>
<span class="line"><span style="color:#88846F;">// a function that looks for events between now and now + lookahead</span></span>
<span class="line"><span style="color:#88846F;">// and schedule all audio events that have been found</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">tick</span><span style="color:#F8F8F2;">() {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> now </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.currentTime;</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> events </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">findEventsBetween</span><span style="color:#F8F8F2;">(now, now </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> lookahead);</span></span>
<span class="line"><span style="color:#F8F8F2;">    events.</span><span style="color:#A6E22E;">forEach</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">event</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">scheduleAudioEvent</span><span style="color:#F8F8F2;">(event));</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// Execute the `tick` fnuction every 100ms</span></span>
<span class="line"><span style="color:#88846F;">// note that the `setInterval` period (2nd argument) is defined in ms</span></span>
<span class="line"><span style="color:#A6E22E;">setInterval</span><span style="color:#F8F8F2;">(tick, lookahead </span><span style="color:#F92672;">*</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">1000</span><span style="color:#F8F8F2;">);</span></span></code></pre></div><p>With such approach, we can maintain and modify a list of event, in which our <code>findEventsBetween</code> function will look for events, and react quite rapidly to any change in the list as only the events registered in the next 100ms are already scheduled in terms of audio rendering.</p><p>So theoretically, we are all good! However with such naive approach, we just fall into another trap. Indeed, as we have seen in the previous tutorial, the JavaScript timing functions: <code>setInterval</code> and <code>setTimeout</code> are not accurate enougth to precisely schedule audio events. And furthermore, as we have just seen, the <code>audioContext.currentTime</code> is not continous neither... Thus this is very possible to end up with a situation such as:</p><p><img src="/webaudio-tutorials/assets/late-callback.f3f46745.png" alt="late-callback"></p><p>Where an events is dropped (start in red) because the callback has been called too late!</p><p>To fix this issue we thus need to decouple the rate at which the callback is called (i.e. its period) and the lookahead, making sure that the period is always lower than the lookahead. With such strategy, we can thus mitigate the accuracy of the <code>setInterval</code> and recover if the callback is not called precisely at the expected time (which <strong><em>will</em></strong> be the case):</p><p><img src="/webaudio-tutorials/assets/period-and-lookahead.83c1705e.png" alt="period-and-lookahead"></p><p>In our speudo implementation, that would mean:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai"><code><span class="line"><span style="color:#88846F;">// define `lookahead` and `period` such as period &lt; lookahead</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> lookahead </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0.15</span><span style="color:#F8F8F2;">; </span><span style="color:#88846F;">// in second</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> period </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0.1</span><span style="color:#F8F8F2;">; </span><span style="color:#88846F;">// in second</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// Schedule events between now and now + lookahead</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">tick</span><span style="color:#F8F8F2;">() {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> now </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.currentTime;</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> events </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">findEventsBetween</span><span style="color:#F8F8F2;">(now, now </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> lookahead);</span></span>
<span class="line"><span style="color:#F8F8F2;">    events.</span><span style="color:#A6E22E;">forEach</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">event</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">scheduleAudioEvent</span><span style="color:#F8F8F2;">(event));</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// Execute the `tick` at `period`</span></span>
<span class="line"><span style="color:#A6E22E;">setInterval</span><span style="color:#F8F8F2;">(tick, period </span><span style="color:#F92672;">*</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">1000</span><span style="color:#F8F8F2;">);</span></span></code></pre></div><p>Now that we have a basic understanding of what lookahead schedulers are and why we need them in interactive applications, let&#39;s implement a simple but working one.</p><h2 id="implement-a-simple-lookahead-scheduler" tabindex="-1">Implement a simple lookahead scheduler <a class="header-anchor" href="#implement-a-simple-lookahead-scheduler" aria-label="Permalink to &quot;Implement a simple lookahead scheduler&quot;">​</a></h2><h3 id="scaffold-project" tabindex="-1">Scaffold project <a class="header-anchor" href="#scaffold-project" aria-label="Permalink to &quot;Scaffold project&quot;">​</a></h3><p>So let&#39;s first scaffold a new project:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki monokai"><code><span class="line"><span style="color:#66D9EF;">cd</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">~/Desktop/webaudio-tutorials</span></span>
<span class="line"><span style="color:#A6E22E;">npx</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">@ircam/create@latest</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">05</span><span style="color:#E6DB74;">-lookahead-scheduler</span></span>
<span class="line"><span style="color:#66D9EF;">cd</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">05</span><span style="color:#E6DB74;">-lookahead-scheduler</span></span>
<span class="line"><span style="color:#A6E22E;">npx</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">serve</span></span></code></pre></div><h3 id="priority-queue" tabindex="-1">Priority queue <a class="header-anchor" href="#priority-queue" aria-label="Permalink to &quot;Priority queue&quot;">​</a></h3><p>A <a href="https://en.wikipedia.org/wiki/Priority_queue" target="_blank" rel="noreferrer">priority queue</a> is a data structure where each element has an associated priority and that guarantees that elements with higher priority are retrieved before elements with lower priority. In our case, when looking for the next event to be scheduled, we want to be sure that this the event which is scheduled in the closest future.</p><p>We won&#39;t go into how to implement such data structure in an efficient way and will just use a list of event sorted according to their associated time. What we want want to be able to do with this queue is:</p><ul><li>add an event with an associated priority (i.e. a time)</li><li>read the item with the highest priority (i.e. smallest time)</li><li>remove the item with highest priority (when it has been scheduled)</li></ul><p>So let&#39;s go with implementing the queue:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-highlighted-lines"><code><span class="line"><span style="color:#88846F;">// ./main.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> audioContext </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">AudioContext</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">resumeAudioContext</span><span style="color:#F8F8F2;">(audioContext);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> buffer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">await</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">loadAudioBuffer</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;./assets/sample.wav&#39;</span><span style="color:#F8F8F2;">, audioContext.sampleRate);</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#66D9EF;font-style:italic;">class</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;text-decoration:underline;">PriorityQueue</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">constructor</span><span style="color:#F8F8F2;">() {</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// array in which we store the elements of the queue</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.queue </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> [];</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// add an event with it&#39;s associated priority into the queue</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">add</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">event</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">time</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// pack `event` and `time` into a single data structure</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> element </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> { event, time };</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// add the data structure into the queue</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.queue.</span><span style="color:#A6E22E;">push</span><span style="color:#F8F8F2;">(element);</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// sort the queue so that the element with hightest priority (i.e. smallest time)</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// is at the beginning of the list</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.queue.</span><span style="color:#A6E22E;">sort</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;font-style:italic;">a</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">b</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> a.time </span><span style="color:#F92672;">&lt;=</span><span style="color:#F8F8F2;"> b.time </span><span style="color:#F92672;">?</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">-</span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">);</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// return the event with highest priority or `null` if the queue is empty</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">head</span><span style="color:#F8F8F2;">() {</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.queue.length </span><span style="color:#F92672;">&gt;</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.queue[</span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">];</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    } </span><span style="color:#F92672;">else</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">null</span><span style="color:#F8F8F2;">;</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    }</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// delete the first element of the queue</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">deleteHead</span><span style="color:#F8F8F2;">() {</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.queue.</span><span style="color:#A6E22E;">shift</span><span style="color:#F8F8F2;">();</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  }</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">}</span></span></code></pre></div><p>Then, we can implement our <code>LookaheadScheduler</code>:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai"><code><span class="line"><span style="color:#88846F;">// ./main.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;text-decoration:underline;">LookaheadScheduler</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">constructor</span><span style="color:#F8F8F2;">() {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.priorityQueue </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">PriorityQueue</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.period </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0.05</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.lookahead </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0.1</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// make sure the tick method is called with the right `this` context,</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// whatever its call context (welcome to JavaScript :)</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.tick </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.tick.</span><span style="color:#A6E22E;">bind</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// launch the periodic `tick` call</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#A6E22E;">setInterval</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.tick, </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.period </span><span style="color:#F92672;">*</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">1000</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">add</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">event</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">time</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// insert the event, time pair into the queue</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.priorityQueue.</span><span style="color:#A6E22E;">add</span><span style="color:#F8F8F2;">(event, time);</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// This function is executed by the `setInterval` every 50ms.</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// This is where all the magic happens</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">tick</span><span style="color:#F8F8F2;">() {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// get the current time of the audio context and the current head of the queue</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> now </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.currentTime;</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;font-style:italic;">let</span><span style="color:#F8F8F2;"> head </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.priorityQueue.</span><span style="color:#A6E22E;">head</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// unstack the queue while the head is in the time frame defined by the lookahead</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">while</span><span style="color:#F8F8F2;"> (head </span><span style="color:#F92672;">&amp;&amp;</span><span style="color:#F8F8F2;"> head.time </span><span style="color:#F92672;">&lt;</span><span style="color:#F8F8F2;"> now </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.lookahead) {</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// the head will be processed so we can remove it from the queue</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.priorityQueue.</span><span style="color:#A6E22E;">deleteHead</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// pick the time and event from the head</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// the time of the event is not `now`, it is smoewhere between now and now + lookahead</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> time </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> head.time;</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> event </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> head.event;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// Execute the event giving it its time as argument.</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// If the event returns a new time, i.e. it wants to be called again later,</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// we can re-insert it right away into the queue.</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> nextTime </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">event</span><span style="color:#F8F8F2;">(time);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (nextTime) {</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.priorityQueue.</span><span style="color:#A6E22E;">add</span><span style="color:#F8F8F2;">(event, nextTime);</span></span>
<span class="line"><span style="color:#F8F8F2;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#88846F;">// pick the next event in the queue and check if it is in the lookahead</span></span>
<span class="line"><span style="color:#F8F8F2;">      head </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.priorityQueue.</span><span style="color:#A6E22E;">head</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div><p>Finally let&#39;s just implement a simple metronome that we will register into the scheduler, and everything together:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> BPM </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">60</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">function</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">metro</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">currentTime</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">  console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(currentTime);</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// play some sound at `currentTime`</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> src </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.</span><span style="color:#A6E22E;">createBufferSource</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">  src.buffer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> buffer;</span></span>
<span class="line"><span style="color:#F8F8F2;">  src.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(audioContext.destination);</span></span>
<span class="line"><span style="color:#F8F8F2;">  src.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">(currentTime);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// return the next time we want to do something</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> currentTime </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">60</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">/</span><span style="color:#F8F8F2;"> BPM;</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// create a new LookaheadScheduler</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> scheduler </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">new</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">LookaheadScheduler</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#88846F;">// add the metronome to the schduler, starting now</span></span>
<span class="line"><span style="color:#F8F8F2;">scheduler.</span><span style="color:#A6E22E;">add</span><span style="color:#F8F8F2;">(metro, audioContext.currentTime);</span></span></code></pre></div><p>If you reload the page, you should now ear a very nice metronome at 60 BPM:</p><audio controls loop src="/webaudio-tutorials/static-assets/metronome-with-scheduler.m4a"></audio><p>Congrats! You have implemented a very simple yet working lookahead scheduler</p><h3 id="going-further" tabindex="-1">Going further <a class="header-anchor" href="#going-further" aria-label="Permalink to &quot;Going further&quot;">​</a></h3><p>Of course, this scheduler is very simple and misses a lot of functionnality, but you have a basis to build upon if you which. For example you could</p><ul><li>Implement the logic to remove a scheduled event from the queue, e.g. to stop the metronome and more advanced synthesis engie)</li><li>Stop and restart the scheduler on demand.</li></ul><p>You coud also improve the demo by:</p><ul><li>Inserting the <code>FeedbackDelay</code> in the graph so that you can check that the jitter issue we add in last tutorial is now solved</li><li>Adding some control over the BPM of the metronome.</li></ul><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;Conclusion&quot;">​</a></h2><p>In this tutorial, you have learned the why and how of lookahead schedulers. In particular why they are needed to mitigate the lack of precision of regular JavaScript timers, and how you can implement a simple version it.</p><p>In the next tutorial, we will build upon this knowledge and tools to learn how to implement a rather powerfull and versatile synthesis technique: the <em>granular synthesis</em>.</p></div></div></main><footer class="VPDocFooter" data-v-a3c25e27 data-v-a2d931e4><!--[--><!--]--><!----><nav class="prev-next" data-v-a2d931e4><div class="pager" data-v-a2d931e4><a class="pager-link prev" href="/webaudio-tutorials/basics/reusable-feedback-delay.html" data-v-a2d931e4><span class="desc" data-v-a2d931e4>Previous page</span><span class="title" data-v-a2d931e4>Reusable feedback delay</span></a></div><div class="pager" data-v-a2d931e4><a class="pager-link next" href="/webaudio-tutorials/scheduling/granular-synthesis.html" data-v-a2d931e4><span class="desc" data-v-a2d931e4>Next page</span><span class="title" data-v-a2d931e4>Granular Synthesis</span></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"basics_web-audio-api-introduction.md\":\"2d5a5248\",\"basics_reusable-feedback-delay.md\":\"183daee8\",\"basics_encapsulating-logic.md\":\"b87db929\",\"scheduling_granular-synthesis.md\":\"981dfc99\",\"scheduling_timing-and-scheduling.md\":\"06659819\",\"first-steps_generalities.md\":\"57d3aee7\",\"scheduling_step-sequencer.md\":\"0b7db5d5\",\"first-steps_setting-up-environment.md\":\"d90e9da7\",\"basics_amplitude-modulation-synthesis.md\":\"06d8523d\",\"first-steps_simple-website.md\":\"6f4c5df3\",\"basics_oscillators-and-audio-files.md\":\"491d8946\",\"index.md\":\"522064d5\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Web Audio Tutorials\",\"description\":\"Set of tutorials on the Web Audio API\",\"base\":\"/webaudio-tutorials/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"}],\"sidebar\":[{\"text\":\"Introduction\",\"link\":\"/\"},{\"text\":\"First steps\",\"items\":[{\"text\":\"Generalities about the Web\",\"link\":\"/first-steps/generalities.md\"},{\"text\":\"Setting up an environment\",\"link\":\"/first-steps/setting-up-environment.md\"},{\"text\":\"Create a simple website\",\"link\":\"/first-steps/simple-website.md\"}]},{\"text\":\"Basics\",\"items\":[{\"text\":\"Web Audio API - Introduction\",\"link\":\"/basics/web-audio-api-introduction.md\"},{\"text\":\"Oscillators and audio files\",\"link\":\"/basics/oscillators-and-audio-files.md\"},{\"text\":\"Ampliture modulation\",\"link\":\"/basics/amplitude-modulation-synthesis.md\"},{\"text\":\"Encapsulating logic\",\"link\":\"/basics/encapsulating-logic.md\"},{\"text\":\"Reusable feedback delay\",\"link\":\"/basics/reusable-feedback-delay.md\"}]},{\"text\":\"Scheduling\",\"items\":[{\"text\":\"Timing and Scheduling\",\"link\":\"/scheduling/timing-and-scheduling.md\"},{\"text\":\"Granular Synthesis\",\"link\":\"/scheduling/granular-synthesis.md\"},{\"text\":\"Step Sequencer\",\"link\":\"/scheduling/step-sequencer.md\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/ircam-ismm/webaudio-tutorials\"}]},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>