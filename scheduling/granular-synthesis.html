<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Granular Synthesis | Web Audio Tutorials</title>
    <meta name="description" content="Set of tutorials on the Web Audio API">
    <meta name="generator" content="VitePress v1.0.0-rc.44">
    <link rel="preload stylesheet" href="/webaudio-tutorials/assets/style.hjrZeGoW.css" as="style">
    
    <script type="module" src="/webaudio-tutorials/assets/app.Br6yg46J.js"></script>
    <link rel="preload" href="/webaudio-tutorials/assets/inter-roman-latin.Bu8hRsVA.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/webaudio-tutorials/assets/chunks/framework.Wgqp_vq1.js">
    <link rel="modulepreload" href="/webaudio-tutorials/assets/chunks/theme.BuQ_LiZC.js">
    <link rel="modulepreload" href="/webaudio-tutorials/assets/scheduling_granular-synthesis.md.DIRpu14j.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar has-sidebar" data-v-7ad780c2 data-v-3efcd581><div class="wrapper" data-v-3efcd581><div class="container" data-v-3efcd581><div class="title" data-v-3efcd581><div class="VPNavBarTitle has-sidebar" data-v-3efcd581 data-v-0ad69264><a class="title" href="/webaudio-tutorials/" data-v-0ad69264><!--[--><!--]--><!----><span data-v-0ad69264>Web Audio Tutorials</span><!--[--><!--]--></a></div></div><div class="content" data-v-3efcd581><div class="content-body" data-v-3efcd581><!--[--><!--]--><div class="VPNavBarSearch search" data-v-3efcd581><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-3efcd581 data-v-f732b5d0><span id="main-nav-aria-label" class="visually-hidden" data-v-f732b5d0>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/webaudio-tutorials/" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Home</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-3efcd581 data-v-283b26e9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-283b26e9 data-v-7df97737 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-7df97737></span><span class="vpi-moon moon" data-v-7df97737></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-3efcd581 data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ircam-ismm/webaudio-tutorials" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-3efcd581 data-v-8e87c032 data-v-af5898d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-af5898d3><span class="vpi-more-horizontal icon" data-v-af5898d3></span></button><div class="menu" data-v-af5898d3><div class="VPMenu" data-v-af5898d3 data-v-e42ed9b3><!----><!--[--><!--[--><!----><div class="group" data-v-8e87c032><div class="item appearance" data-v-8e87c032><p class="label" data-v-8e87c032>Appearance</p><div class="appearance-action" data-v-8e87c032><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-8e87c032 data-v-7df97737 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-7df97737></span><span class="vpi-moon moon" data-v-7df97737></span><!--]--></span></span></button></div></div></div><div class="group" data-v-8e87c032><div class="item social-links" data-v-8e87c032><div class="VPSocialLinks social-links-list" data-v-8e87c032 data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ircam-ismm/webaudio-tutorials" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-3efcd581 data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-3efcd581><div class="divider-line" data-v-3efcd581></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2488c25a><span class="vpi-align-left menu-icon" data-v-2488c25a></span><span class="menu-text" data-v-2488c25a>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-0b5c97a1><button data-v-0b5c97a1>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-d8b57b2d data-v-4871f9f5><div class="curtain" data-v-4871f9f5></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-4871f9f5><span class="visually-hidden" id="sidebar-aria-label" data-v-4871f9f5> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-4871f9f5><section class="VPSidebarItem level-0" data-v-4871f9f5 data-v-12a5e56c><!----><div class="items" data-v-12a5e56c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Introduction</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-4871f9f5><section class="VPSidebarItem level-0" data-v-4871f9f5 data-v-12a5e56c><div class="item" role="button" tabindex="0" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><h2 class="text" data-v-12a5e56c>First steps</h2><!----></div><div class="items" data-v-12a5e56c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/first-steps/generalities.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Generalities about the Web</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/first-steps/setting-up-environment.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Setting up an environment</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/first-steps/simple-website.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Create a simple website</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-4871f9f5><section class="VPSidebarItem level-0" data-v-4871f9f5 data-v-12a5e56c><div class="item" role="button" tabindex="0" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><h2 class="text" data-v-12a5e56c>Basics</h2><!----></div><div class="items" data-v-12a5e56c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/basics/web-audio-api-introduction.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Web Audio API - Introduction</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/basics/oscillators-and-audio-files.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Oscillators and audio files</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/basics/amplitude-modulation-synthesis.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Amplitude modulation</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/basics/encapsulating-logic.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Encapsulating logic</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/basics/reusable-feedback-delay.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Reusable feedback delay</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-4871f9f5><section class="VPSidebarItem level-0 has-active" data-v-4871f9f5 data-v-12a5e56c><div class="item" role="button" tabindex="0" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><h2 class="text" data-v-12a5e56c>Scheduling</h2><!----></div><div class="items" data-v-12a5e56c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/scheduling/timing-and-scheduling.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Timing and Scheduling</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/scheduling/granular-synthesis.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Granular Synthesis</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/scheduling/step-sequencer.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Step Sequencer</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-sidebar has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-cb998dce data-v-6b52fe58><div class="content" data-v-6b52fe58><div class="outline-marker" data-v-6b52fe58></div><div class="outline-title" role="heading" aria-level="2" data-v-6b52fe58>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-6b52fe58><span class="visually-hidden" id="doc-outline-aria-label" data-v-6b52fe58> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-6b52fe58 data-v-53c99d69><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _webaudio-tutorials_scheduling_granular-synthesis" data-v-e6f2a212><div><h1 id="granular-synthesis" tabindex="-1">Granular Synthesis <a class="header-anchor" href="#granular-synthesis" aria-label="Permalink to &quot;Granular Synthesis&quot;">​</a></h1><p>In this tutorial, you will learn how to implement a granular synthesizer using the Web Audio API leveraging on the lookahead scheduling technique we have seen in the previous tutorial.</p><h3 id="related-documentation" tabindex="-1">Related Documentation <a class="header-anchor" href="#related-documentation" aria-label="Permalink to &quot;Related Documentation&quot;">​</a></h3><ul><li><a href="https://en.wikipedia.org/wiki/Granular_synthesis" target="_blank" rel="noreferrer">Granular Synthesis - Wikipedia</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBufferSourceNode/start" target="_blank" rel="noreferrer"><code>AudioBufferSourceNode.start</code></a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBufferSourceNode/playbackRate" target="_blank" rel="noreferrer"><code>AudioBufferSourceNode.playbackRate</code></a></li></ul><h2 id="general-principles" tabindex="-1">General principles <a class="header-anchor" href="#general-principles" aria-label="Permalink to &quot;General principles&quot;">​</a></h2><p>Granular synthesis is a sound synthesis technique that consists in cutting a audio files in small pieces of sound of around 5 to 200 ms called <strong><em>grains</em></strong>. These grains are then played back and layered to reconstruct a new sound. Each grain can also be manipulated independently by modifying for example their pitch, volume, etc.</p><p><img src="/webaudio-tutorials/assets/granular-synthesis.BUTSAAVC.png" alt="granular-synthesis"></p><h2 id="implement-the-synthesis-engine" tabindex="-1">Implement the synthesis engine <a class="header-anchor" href="#implement-the-synthesis-engine" aria-label="Permalink to &quot;Implement the synthesis engine&quot;">​</a></h2><h3 id="scaffold-the-project" tabindex="-1">Scaffold the project <a class="header-anchor" href="#scaffold-the-project" aria-label="Permalink to &quot;Scaffold the project&quot;">​</a></h3><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#66D9EF;">cd</span><span style="color:#E6DB74;"> ~/Desktop/webaudio-tutorials</span></span>
<span class="line"><span style="color:#A6E22E;">npx</span><span style="color:#E6DB74;"> @ircam/create@latest</span><span style="color:#AE81FF;"> 06</span><span style="color:#E6DB74;">-granular-synthesis</span><span style="color:#AE81FF;">  --template=nobuild</span></span>
<span class="line"><span style="color:#66D9EF;">cd</span><span style="color:#AE81FF;"> 06</span><span style="color:#E6DB74;">-granular-synthesis</span></span>
<span class="line"><span style="color:#A6E22E;">npx</span><span style="color:#E6DB74;"> serve</span></span></code></pre></div><h3 id="import-a-library-for-scheduling" tabindex="-1">Import a library for scheduling <a class="header-anchor" href="#import-a-library-for-scheduling" aria-label="Permalink to &quot;Import a library for scheduling&quot;">​</a></h3><p>First, let&#39;s just import a library that will provide us with a much more robust version of the scheduler we implemented in last tutorial, while being build on the same principles:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">// ./main.js</span></span>
<span class="line highlighted"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { html, render } </span><span style="color:#F92672;">from</span><span style="color:#E6DB74;"> &#39;https://unpkg.com/lit-html&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { Scheduler } </span><span style="color:#F92672;">from</span><span style="color:#E6DB74;"> &#39;https://unpkg.com/@ircam/sc-scheduling@0.1.6&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#E6DB74;"> &#39;https://unpkg.com/@ircam/sc-components@latest&#39;</span><span style="color:#F8F8F2;">;</span></span></code></pre></div><p>Replace the default sample in <code>./assets/sample.wav</code> with another longer one, and eventually modify the <code>loadAudioBuffer</code> first argument to match you file name:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff vp-code"><code><span class="line"><span style="color:#88846F;">// ./main.js</span></span>
<span class="line diff remove"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> buffer </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> await</span><span style="color:#A6E22E;"> loadAudioBuffer</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;./assets/sample.wav&#39;</span><span style="color:#F8F8F2;">, audioContext.sampleRate); </span></span>
<span class="line diff add"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> buffer </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> await</span><span style="color:#A6E22E;"> loadAudioBuffer</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;./assets/hendrix.wav&#39;</span><span style="color:#F8F8F2;">, audioContext.sampleRate); </span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The sample used in the tutorial can be downloaded <a href="/webaudio-tutorials/static-assets/granular-synthesis-samples.zip">here</a></p></div><h3 id="implement-the-audio-engine" tabindex="-1">Implement the audio engine <a class="header-anchor" href="#implement-the-audio-engine" aria-label="Permalink to &quot;Implement the audio engine&quot;">​</a></h3><p>Let&#39;s start with defining the new class which will be our granular engine:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> buffer </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> await</span><span style="color:#A6E22E;"> loadAudioBuffer</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;./assets/sample.wav&#39;</span><span style="color:#F8F8F2;">, audioContext.sampleRate);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline;">GranularSynth</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">  constructor</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">audioContext</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">buffer</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.audioContext </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext;</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.buffer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> buffer;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">    // time interval between each grain</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.period </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 0.025</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#88846F;">    // duration of each grain</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.duration </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 0.1</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#88846F;">    // position of the grain in the buffer</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.position </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 0</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">    // create an output gain on wich will connect all our grains</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.output </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createGain</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#88846F;">    // bind the render method so that we don&#39;t the instance context</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.render </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.render.</span><span style="color:#A6E22E;">bind</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6E22E;">  render</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">currentTime</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#F8F8F2;">    console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(currentTime);</span></span>
<span class="line"><span style="color:#88846F;">    // ask to be called at time of next grain</span></span>
<span class="line"><span style="color:#F92672;">    return</span><span style="color:#F8F8F2;"> currentTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.period;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div><p>For now, this doesn&#39;t make any sound, but let&#39;s see how to make it work with the scheduler:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">// ./main.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline;">GranularSynth</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#88846F;">    // ...</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">// create a new scheduler, in the audioContext timeline</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> scheduler </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> new</span><span style="color:#A6E22E;"> Scheduler</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> audioContext.currentTime);</span></span>
<span class="line"><span style="color:#88846F;">// create out granular synth and connect it to audio destination</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> granular </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> new</span><span style="color:#A6E22E;"> GranularSynth</span><span style="color:#F8F8F2;">(audioContext, buffer);</span></span>
<span class="line"><span style="color:#F8F8F2;">granular.output.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(audioContext.destination);</span></span>
<span class="line"><span style="color:#88846F;">// register the synth into the scheduler and start it now</span></span>
<span class="line"><span style="color:#F8F8F2;">scheduler.</span><span style="color:#A6E22E;">add</span><span style="color:#F8F8F2;">(granular.render, audioContext.currentTime);</span></span></code></pre></div><p>If you reload the page and open the console, you should see the start time of the grains logged into the console:</p><p><img src="/webaudio-tutorials/assets/scheduler-working.B490JIm5.png" alt="scheduler-working"></p><p>Let&#39;s then continue with implementing our render method:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">// ./main.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline;">GranularSynth</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">  constructor</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">audioContext</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">buffer</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#88846F;">    // ...</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6E22E;">  render</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">currentTime</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#88846F;">    // create our evenvelop gain</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> env </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createGain</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#88846F;">    // connect it to output</span></span>
<span class="line"><span style="color:#F8F8F2;">    env.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.output);</span></span>
<span class="line"><span style="color:#88846F;">    // schedule the fadein and fadeout</span></span>
<span class="line"><span style="color:#F8F8F2;">    env.gain.value </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 0</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">    env.gain.</span><span style="color:#A6E22E;">setValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">, currentTime);</span></span>
<span class="line"><span style="color:#F8F8F2;">    env.gain.</span><span style="color:#A6E22E;">linearRampToValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">, currentTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.duration </span><span style="color:#F92672;">/</span><span style="color:#AE81FF;"> 2</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">    env.gain.</span><span style="color:#A6E22E;">linearRampToValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">, currentTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.duration);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">    // create the source that will play our grain</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> src </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createBufferSource</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    src.buffer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> buffer;</span></span>
<span class="line"><span style="color:#88846F;">    // connect to output</span></span>
<span class="line"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(env);</span></span>
<span class="line"><span style="color:#88846F;">    // play the grain at given position and for given duration</span></span>
<span class="line"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">(currentTime, </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.position);</span></span>
<span class="line"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">stop</span><span style="color:#F8F8F2;">(currentTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.duration);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">    // increment position so that we read the file at speed divided by 4</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.position </span><span style="color:#F92672;">+=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.period </span><span style="color:#F92672;">/</span><span style="color:#AE81FF;"> 4</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#88846F;">    // make sure we don&#39;t try to pick a grain outside the buffer</span></span>
<span class="line"><span style="color:#F92672;">    if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.position </span><span style="color:#F92672;">&gt;</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.buffer.duration </span><span style="color:#F92672;">-</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.duration) {</span></span>
<span class="line"><span style="color:#FD971F;">      this</span><span style="color:#F8F8F2;">.position </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 0</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">    // ask to be called at time of next grain</span></span>
<span class="line"><span style="color:#F92672;">    return</span><span style="color:#F8F8F2;"> currentTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.period;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div><p>The code is finally quite simple as we just create an audio buffer source node, pipe it into gain with a simple envelop automation, which is itself connected to the output node of the synth. At the end of the render method, we just update the position of the next grain so that the source file is played back at a portion of its normal speed.</p><p>When you reload the page you should now hear your GranularSynth in action!</p><h2 id="adding-controls" tabindex="-1">Adding controls <a class="header-anchor" href="#adding-controls" aria-label="Permalink to &quot;Adding controls&quot;">​</a></h2><p>Let&#39;s now finalize our application to add control interfaces to change the parameters of the synthesis in real-time.</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">// ./main.js</span></span>
<span class="line"><span style="color:#A6E22E;">render</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">html</span><span style="color:#E6DB74;">`</span></span>
<span class="line"><span style="color:#E6DB74;">  &lt;h1&gt;06-granular-synthesis&lt;/h1&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;div&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-text&gt;Period&lt;/sc-text&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-slider</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      min=&quot;0.005&quot;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      max=&quot;0.1&quot;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      value=</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">granular.period</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      @input=</span><span style="color:#F92672;">${</span><span style="color:#FD971F;font-style:italic;">e</span><span style="color:#66D9EF;font-style:italic;"> =&gt;</span><span style="color:#F8F8F2;"> granular.period </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> e.detail.value</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      number-box</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &gt;&lt;/sc-slider&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;/div&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;div&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-text&gt;Duration&lt;/sc-text&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-slider</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      min=&quot;0.01&quot;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      max=&quot;0.5&quot;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      value=</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">granular.duration</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      @input=</span><span style="color:#F92672;">${</span><span style="color:#FD971F;font-style:italic;">e</span><span style="color:#66D9EF;font-style:italic;"> =&gt;</span><span style="color:#F8F8F2;"> granular.duration </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> e.detail.value</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      number-box</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &gt;&lt;/sc-slider&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;/div&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;div&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-text&gt;Position&lt;/sc-text&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-slider</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      min=&quot;0&quot;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      max=</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">buffer.duration</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      value=</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">granular.position</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      @input=</span><span style="color:#F92672;">${</span><span style="color:#FD971F;font-style:italic;">e</span><span style="color:#66D9EF;font-style:italic;"> =&gt;</span><span style="color:#F8F8F2;"> granular.position </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> e.detail.value</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      number-box</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &gt;&lt;/sc-slider&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;/div&gt;</span></span>
<span class="line"><span style="color:#E6DB74;">`</span><span style="color:#F8F8F2;">, document.body);</span></span></code></pre></div><p>And change our synth so that the position is not updated automatically but only controlled by the slider:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff vp-code"><code><span class="line"><span style="color:#88846F;">// ./main.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline;">GranularSynth</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">  constructor</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">audioContext</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">buffer</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#88846F;">    // ...</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6E22E;">  render</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">currentTime</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#88846F;">    // ...</span></span>
<span class="line"></span>
<span class="line diff remove"><span style="color:#88846F;">    // increment position so that we read the file at speed divided by 4</span></span>
<span class="line diff remove"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.position </span><span style="color:#F92672;">+=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.period </span><span style="color:#F92672;">/</span><span style="color:#AE81FF;"> 4</span><span style="color:#F8F8F2;">; </span></span>
<span class="line diff remove"><span style="color:#88846F;">    // make sure we don&#39;t try to pick a grain outside the buffer</span></span>
<span class="line diff remove"><span style="color:#F92672;">    if</span><span style="color:#F8F8F2;"> (</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.position </span><span style="color:#F92672;">&gt;</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.buffer.duration </span><span style="color:#F92672;">-</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.duration) { </span></span>
<span class="line diff remove"><span style="color:#FD971F;">      this</span><span style="color:#F8F8F2;">.position </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 0</span><span style="color:#F8F8F2;">; </span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">    } </span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">    // ask to be called at time of next grain</span></span>
<span class="line"><span style="color:#F92672;">    return</span><span style="color:#F8F8F2;"> currentTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.period;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div><p>If you play a bit with the controls, you can ear that with very low <code>period</code> values, the resulting synthesis produces pitched audible artifacts, which might not be desirable. This is due to the fact these values are so small that they start to be audible on their own, e.g. a period of 0.005 ms corresponds to 200 Hz.</p><p>A way to remove these artifacts is to add some jitter, or noise on the scheduling of the grain:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff vp-code"><code><span class="line"><span style="color:#88846F;">// ./main.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline;">GranularSynth</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">  constructor</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">audioContext</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">buffer</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line"><span style="color:#88846F;">    // ...</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6E22E;">  render</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">currentTime</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line diff add"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> jitter </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> Math.</span><span style="color:#A6E22E;">random</span><span style="color:#F8F8F2;">() </span><span style="color:#F92672;">*</span><span style="color:#AE81FF;"> 0.002</span><span style="color:#F8F8F2;">; </span></span>
<span class="line diff add"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> grainTime </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> currentTime </span><span style="color:#F92672;">+</span><span style="color:#F8F8F2;"> jitter; </span></span>
<span class="line"><span style="color:#88846F;">    // create our evenvelop gain</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> env </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createGain</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#88846F;">    // connect it to output</span></span>
<span class="line"><span style="color:#F8F8F2;">    env.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.output);</span></span>
<span class="line"><span style="color:#88846F;">    // schedule the fadein and fadeout</span></span>
<span class="line"><span style="color:#F8F8F2;">    env.gain.value </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 0</span><span style="color:#F8F8F2;">;</span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">    env.gain.</span><span style="color:#A6E22E;">setValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">, currentTime); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    env.gain.</span><span style="color:#A6E22E;">setValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">, grainTime); </span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">    env.gain.</span><span style="color:#A6E22E;">linearRampToValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">, currentTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.duration </span><span style="color:#F92672;">/</span><span style="color:#AE81FF;"> 2</span><span style="color:#F8F8F2;">); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    env.gain.</span><span style="color:#A6E22E;">linearRampToValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">, grainTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.duration </span><span style="color:#F92672;">/</span><span style="color:#AE81FF;"> 2</span><span style="color:#F8F8F2;">); </span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">    env.gain.</span><span style="color:#A6E22E;">linearRampToValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">, currentTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.duration); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    env.gain.</span><span style="color:#A6E22E;">linearRampToValueAtTime</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">, grainTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.duration); </span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">    // create the source that will play our grain</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> src </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createBufferSource</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">    src.buffer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> buffer;</span></span>
<span class="line"><span style="color:#88846F;">    // connect to output</span></span>
<span class="line"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(env);</span></span>
<span class="line"><span style="color:#88846F;">    // play the grain at given position and for given duration</span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">(currentTime, </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.position); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">(grainTime, </span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.position); </span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">stop</span><span style="color:#F8F8F2;">(currentTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.duration); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">stop</span><span style="color:#F8F8F2;">(grainTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.duration); </span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846F;">    // ask to be called at time of next grain</span></span>
<span class="line"><span style="color:#F92672;">    return</span><span style="color:#F8F8F2;"> currentTime </span><span style="color:#F92672;">+</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.period;</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div><p>Congrats! Your granular synthesizer is now fully working</p><h2 id="going-further" tabindex="-1">Going further <a class="header-anchor" href="#going-further" aria-label="Permalink to &quot;Going further&quot;">​</a></h2><p>To improve the application, you could for example add some controls over:</p><ul><li>The pitch of each grain, using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioBufferSourceNode/playbackRate" target="_blank" rel="noreferrer"><code>AudioBufferSourceNode.playbackRate</code></a> rate param</li><li>Allow users to use their own audio file, by providing a way to drag and drop it directly into the interface, cf. <a href="https://ircam-ismm.github.io/sc-components/sc-dragndrop" target="_blank" rel="noreferrer"><code>&lt;sc-dragndrop&gt;</code></a></li></ul><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;Conclusion&quot;">​</a></h2><p>In this tutorial, you have learned how to leverage on the scheduling technique we have seen in the previous tutorial to build your own granular synthesizer.</p><p>In the next tutorial, we will continue with the exploration of the scheduling by implementing a simple step sequencer.</p></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-b77f9094><!--[--><!--]--><!----><nav class="prev-next" data-v-b77f9094><div class="pager" data-v-b77f9094><a class="VPLink link pager-link prev" href="/webaudio-tutorials/scheduling/timing-and-scheduling.html" data-v-b77f9094><!--[--><span class="desc" data-v-b77f9094>Previous page</span><span class="title" data-v-b77f9094>Timing and Scheduling</span><!--]--></a></div><div class="pager" data-v-b77f9094><a class="VPLink link pager-link next" href="/webaudio-tutorials/scheduling/step-sequencer.html" data-v-b77f9094><!--[--><span class="desc" data-v-b77f9094>Next page</span><span class="title" data-v-b77f9094>Step Sequencer</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"basics_web-audio-api-introduction.md\":\"CycO03f_\",\"first-steps_setting-up-environment.md\":\"DGEXyCmx\",\"index.md\":\"Cnpzc8jN\",\"basics_reusable-feedback-delay.md\":\"ChVEG-Cp\",\"basics_encapsulating-logic.md\":\"B02WJp0E\",\"first-steps_generalities.md\":\"BdbxhhUB\",\"scheduling_timing-and-scheduling.md\":\"Dwsqu1yd\",\"basics_amplitude-modulation-synthesis.md\":\"CdUU5gEW\",\"basics_oscillators-and-audio-files.md\":\"-03dkhFt\",\"scheduling_step-sequencer.md\":\"BLR4AqBr\",\"scheduling_granular-synthesis.md\":\"DIRpu14j\",\"first-steps_simple-website.md\":\"kYRZq57U\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Web Audio Tutorials\",\"description\":\"Set of tutorials on the Web Audio API\",\"base\":\"/webaudio-tutorials/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"}],\"sidebar\":[{\"text\":\"Introduction\",\"link\":\"/\"},{\"text\":\"First steps\",\"items\":[{\"text\":\"Generalities about the Web\",\"link\":\"/first-steps/generalities.md\"},{\"text\":\"Setting up an environment\",\"link\":\"/first-steps/setting-up-environment.md\"},{\"text\":\"Create a simple website\",\"link\":\"/first-steps/simple-website.md\"}]},{\"text\":\"Basics\",\"items\":[{\"text\":\"Web Audio API - Introduction\",\"link\":\"/basics/web-audio-api-introduction.md\"},{\"text\":\"Oscillators and audio files\",\"link\":\"/basics/oscillators-and-audio-files.md\"},{\"text\":\"Amplitude modulation\",\"link\":\"/basics/amplitude-modulation-synthesis.md\"},{\"text\":\"Encapsulating logic\",\"link\":\"/basics/encapsulating-logic.md\"},{\"text\":\"Reusable feedback delay\",\"link\":\"/basics/reusable-feedback-delay.md\"}]},{\"text\":\"Scheduling\",\"items\":[{\"text\":\"Timing and Scheduling\",\"link\":\"/scheduling/timing-and-scheduling.md\"},{\"text\":\"Granular Synthesis\",\"link\":\"/scheduling/granular-synthesis.md\"},{\"text\":\"Step Sequencer\",\"link\":\"/scheduling/step-sequencer.md\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/ircam-ismm/webaudio-tutorials\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>