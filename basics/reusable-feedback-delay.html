<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Implementing a Reusable Feedback Delay | Web Audio Tutorials</title>
    <meta name="description" content="Set of tutorials on the Web Audio API">
    <meta name="generator" content="VitePress v1.0.0-rc.44">
    <link rel="preload stylesheet" href="/webaudio-tutorials/assets/style.hjrZeGoW.css" as="style">
    
    <script type="module" src="/webaudio-tutorials/assets/app.DIcvSzNg.js"></script>
    <link rel="preload" href="/webaudio-tutorials/assets/inter-roman-latin.Bu8hRsVA.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/webaudio-tutorials/assets/chunks/framework.Wgqp_vq1.js">
    <link rel="modulepreload" href="/webaudio-tutorials/assets/chunks/theme.BeqpQd1Y.js">
    <link rel="modulepreload" href="/webaudio-tutorials/assets/basics_reusable-feedback-delay.md.ChVEG-Cp.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-d8b57b2d><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-d8b57b2d data-v-7ad780c2><div class="VPNavBar has-sidebar" data-v-7ad780c2 data-v-3efcd581><div class="wrapper" data-v-3efcd581><div class="container" data-v-3efcd581><div class="title" data-v-3efcd581><div class="VPNavBarTitle has-sidebar" data-v-3efcd581 data-v-0ad69264><a class="title" href="/webaudio-tutorials/" data-v-0ad69264><!--[--><!--]--><!----><span data-v-0ad69264>Web Audio Tutorials</span><!--[--><!--]--></a></div></div><div class="content" data-v-3efcd581><div class="content-body" data-v-3efcd581><!--[--><!--]--><div class="VPNavBarSearch search" data-v-3efcd581><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-3efcd581 data-v-f732b5d0><span id="main-nav-aria-label" class="visually-hidden" data-v-f732b5d0>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/webaudio-tutorials/" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Home</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-3efcd581 data-v-283b26e9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-283b26e9 data-v-7df97737 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-7df97737></span><span class="vpi-moon moon" data-v-7df97737></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-3efcd581 data-v-ef6192dc data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ircam-ismm/webaudio-tutorials" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-3efcd581 data-v-8e87c032 data-v-af5898d3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-af5898d3><span class="vpi-more-horizontal icon" data-v-af5898d3></span></button><div class="menu" data-v-af5898d3><div class="VPMenu" data-v-af5898d3 data-v-e42ed9b3><!----><!--[--><!--[--><!----><div class="group" data-v-8e87c032><div class="item appearance" data-v-8e87c032><p class="label" data-v-8e87c032>Appearance</p><div class="appearance-action" data-v-8e87c032><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-8e87c032 data-v-7df97737 data-v-b4ccac88><span class="check" data-v-b4ccac88><span class="icon" data-v-b4ccac88><!--[--><span class="vpi-sun sun" data-v-7df97737></span><span class="vpi-moon moon" data-v-7df97737></span><!--]--></span></span></button></div></div></div><div class="group" data-v-8e87c032><div class="item social-links" data-v-8e87c032><div class="VPSocialLinks social-links-list" data-v-8e87c032 data-v-e71e869c><!--[--><a class="VPSocialLink no-icon" href="https://github.com/ircam-ismm/webaudio-tutorials" aria-label="github" target="_blank" rel="noopener" data-v-e71e869c data-v-358b6670><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-3efcd581 data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><div class="divider" data-v-3efcd581><div class="divider-line" data-v-3efcd581></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-d8b57b2d data-v-2488c25a><div class="container" data-v-2488c25a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-2488c25a><span class="vpi-align-left menu-icon" data-v-2488c25a></span><span class="menu-text" data-v-2488c25a>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-2488c25a data-v-0b5c97a1><button data-v-0b5c97a1>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-d8b57b2d data-v-4871f9f5><div class="curtain" data-v-4871f9f5></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-4871f9f5><span class="visually-hidden" id="sidebar-aria-label" data-v-4871f9f5> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-4871f9f5><section class="VPSidebarItem level-0" data-v-4871f9f5 data-v-12a5e56c><!----><div class="items" data-v-12a5e56c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Introduction</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-4871f9f5><section class="VPSidebarItem level-0" data-v-4871f9f5 data-v-12a5e56c><div class="item" role="button" tabindex="0" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><h2 class="text" data-v-12a5e56c>First steps</h2><!----></div><div class="items" data-v-12a5e56c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/first-steps/generalities.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Generalities about the Web</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/first-steps/setting-up-environment.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Setting up an environment</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/first-steps/simple-website.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Create a simple website</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-4871f9f5><section class="VPSidebarItem level-0 has-active" data-v-4871f9f5 data-v-12a5e56c><div class="item" role="button" tabindex="0" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><h2 class="text" data-v-12a5e56c>Basics</h2><!----></div><div class="items" data-v-12a5e56c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/basics/web-audio-api-introduction.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Web Audio API - Introduction</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/basics/oscillators-and-audio-files.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Oscillators and audio files</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/basics/amplitude-modulation-synthesis.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Ampliture modulation</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/basics/encapsulating-logic.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Encapsulating logic</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/basics/reusable-feedback-delay.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Reusable feedback delay</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-4871f9f5><section class="VPSidebarItem level-0" data-v-4871f9f5 data-v-12a5e56c><div class="item" role="button" tabindex="0" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><h2 class="text" data-v-12a5e56c>Scheduling</h2><!----></div><div class="items" data-v-12a5e56c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/scheduling/timing-and-scheduling.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Timing and Scheduling</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/scheduling/granular-synthesis.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Granular Synthesis</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-12a5e56c data-v-12a5e56c><div class="item" data-v-12a5e56c><div class="indicator" data-v-12a5e56c></div><a class="VPLink link link" href="/webaudio-tutorials/scheduling/step-sequencer.html" data-v-12a5e56c><!--[--><p class="text" data-v-12a5e56c>Step Sequencer</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-d8b57b2d data-v-9a6c75ad><div class="VPDoc has-sidebar has-aside" data-v-9a6c75ad data-v-e6f2a212><!--[--><!--]--><div class="container" data-v-e6f2a212><div class="aside" data-v-e6f2a212><div class="aside-curtain" data-v-e6f2a212></div><div class="aside-container" data-v-e6f2a212><div class="aside-content" data-v-e6f2a212><div class="VPDocAside" data-v-e6f2a212 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-cb998dce data-v-6b52fe58><div class="content" data-v-6b52fe58><div class="outline-marker" data-v-6b52fe58></div><div class="outline-title" role="heading" aria-level="2" data-v-6b52fe58>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-6b52fe58><span class="visually-hidden" id="doc-outline-aria-label" data-v-6b52fe58> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-6b52fe58 data-v-53c99d69><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-e6f2a212><div class="content-container" data-v-e6f2a212><!--[--><!--]--><main class="main" data-v-e6f2a212><div style="position:relative;" class="vp-doc _webaudio-tutorials_basics_reusable-feedback-delay" data-v-e6f2a212><div><h1 id="implementing-a-reusable-feedback-delay" tabindex="-1">Implementing a Reusable Feedback Delay <a class="header-anchor" href="#implementing-a-reusable-feedback-delay" aria-label="Permalink to &quot;Implementing a Reusable Feedback Delay&quot;">​</a></h1><p>In this tutorial, we will build on top of the patterns we just reviewed to build a reusable feedback delay effect.</p><h3 id="related-documentation" tabindex="-1">Related Documentation <a class="header-anchor" href="#related-documentation" aria-label="Permalink to &quot;Related Documentation&quot;">​</a></h3><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/setInterval" target="_blank" rel="noreferrer"><code>setInterval</code></a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/DelayNode" target="_blank" rel="noreferrer"><code>DelayNode</code></a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioParam/setTargetAtTime" target="_blank" rel="noreferrer"><code>setTargetAtTime</code></a></li></ul><h2 id="scaffolding-project" tabindex="-1">Scaffolding project <a class="header-anchor" href="#scaffolding-project" aria-label="Permalink to &quot;Scaffolding project&quot;">​</a></h2><p>First things first, let&#39;s create a new project using the <code>@ircam/create</code> command. Open a <code>Terminal</code> and write the following commands:</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#66D9EF;">cd</span><span style="color:#E6DB74;"> ~/Desktop/webaudio-tutorials</span></span>
<span class="line"><span style="color:#A6E22E;">npx</span><span style="color:#E6DB74;"> @ircam/create@latest</span><span style="color:#AE81FF;"> 04</span><span style="color:#E6DB74;">-feedback-delay</span><span style="color:#AE81FF;">  --template=nobuild</span></span>
<span class="line"><span style="color:#66D9EF;">cd</span><span style="color:#AE81FF;"> 04</span><span style="color:#E6DB74;">-feedback-delay</span></span>
<span class="line"><span style="color:#A6E22E;">npx</span><span style="color:#E6DB74;"> serve</span></span></code></pre></div><p>Then open the <code>04-feedback-delay</code> directory in your text editor</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>If you are wondering what&#39;s going on here, please check the more detailed step by step guide <a href="./amplitude-modulation-synthesis.html#scaffold-the-project-automatically">here</a></p></div><h2 id="trigger-source-at-regular-interval" tabindex="-1">Trigger source at regular interval <a class="header-anchor" href="#trigger-source-at-regular-interval" aria-label="Permalink to &quot;Trigger source at regular interval&quot;">​</a></h2><p>To test our feedback delay, let&#39;s create some source triggered at regular interval. Fortunately, the default project we just created already provides us an <code>AudioBuffer</code> which will be perfect to that end.</p><p>Then, let&#39;s just modify the code so that instead of having to manually trigger the source, it is triggered automatically at a regular interval, for example every second.</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff vp-code"><code><span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { html, render } </span><span style="color:#F92672;">from</span><span style="color:#E6DB74;"> &#39;https://unpkg.com/lit-html&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#E6DB74;"> &#39;https://unpkg.com/@ircam/sc-components@latest&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> resumeAudioContext </span><span style="color:#F92672;">from</span><span style="color:#E6DB74;"> &#39;./lib/resume-audio-context.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> loadAudioBuffer </span><span style="color:#F92672;">from</span><span style="color:#E6DB74;"> &#39;./lib/load-audio-buffer.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> audioContext </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> new</span><span style="color:#A6E22E;"> AudioContext</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#A6E22E;"> resumeAudioContext</span><span style="color:#F8F8F2;">(audioContext);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> buffer </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> await</span><span style="color:#A6E22E;"> loadAudioBuffer</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;./assets/sample.wav&#39;</span><span style="color:#F8F8F2;">, audioContext.sampleRate);</span></span>
<span class="line"></span>
<span class="line diff add"><span style="color:#A6E22E;">setInterval</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> { </span></span>
<span class="line diff add"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> src </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.</span><span style="color:#A6E22E;">createBufferSource</span><span style="color:#F8F8F2;">(); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(audioContext.destination); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    src.buffer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> buffer; </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">(); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">}, </span><span style="color:#AE81FF;">1000</span><span style="color:#F8F8F2;">); </span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6E22E;">render</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">html</span><span style="color:#E6DB74;">`</span></span>
<span class="line"><span style="color:#E6DB74;">  &lt;h1&gt;04-feedback-delay&lt;/h1&gt;</span></span>
<span class="line diff remove"><span style="color:#E6DB74;">  &lt;sc-bang</span></span>
<span class="line diff remove"><span style="color:#E6DB74;">    @input=</span><span style="color:#F92672;">${</span><span style="color:#FD971F;font-style:italic;">e</span><span style="color:#66D9EF;font-style:italic;"> =&gt;</span><span style="color:#F8F8F2;"> { </span></span>
<span class="line diff remove"><span style="color:#66D9EF;font-style:italic;">      const</span><span style="color:#F8F8F2;"> src </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.</span><span style="color:#A6E22E;">createBufferSource</span><span style="color:#F8F8F2;">(); </span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">      src.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(audioContext.destination); </span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">      src.buffer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> buffer; </span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">      src.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">(); </span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">    }</span><span style="color:#F92672;">}</span></span>
<span class="line diff remove"><span style="color:#E6DB74;">  &gt;&lt;/sc-bang&gt;</span></span>
<span class="line"><span style="color:#E6DB74;">`</span><span style="color:#F8F8F2;">, document.body);</span></span></code></pre></div><p>If you reload the page you should now ear the following:</p><audio controls loop src="/webaudio-tutorials/static-assets/feedback-delay-trigger.m4a"></audio><h2 id="create-a-module-for-the-feedbackdelay-class" tabindex="-1">Create a module for the FeedbackDelay class <a class="header-anchor" href="#create-a-module-for-the-feedbackdelay-class" aria-label="Permalink to &quot;Create a module for the FeedbackDelay class&quot;">​</a></h2><p>To implement our <code>FeedbackDelay</code>, we will create a new module that we will import into our <code>main.js</code> file. Create a new file called <code>FeedbackDelay.js</code> inside the <code>lib</code> directory:</p><div class="language-md"><button title="Copy Code" class="copy"></button><span class="lang">md</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#F8F8F2;">04-feedback-delay</span></span>
<span class="line"><span style="color:#F8F8F2;">├── assets              </span></span>
<span class="line"><span style="color:#F8F8F2;">├── lib                 </span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">│   ├── FeedbackDelay.js</span></span>
<span class="line"><span style="color:#F8F8F2;">│   ├── load-audio-buffer.js</span></span>
<span class="line"><span style="color:#F8F8F2;">│   └── resume-audio-context.js</span></span>
<span class="line"><span style="color:#F8F8F2;">├── index.html</span></span>
<span class="line"><span style="color:#F8F8F2;">├── main.js</span></span>
<span class="line"><span style="color:#F8F8F2;">├── README.md</span></span>
<span class="line"><span style="color:#F8F8F2;">└── styles.css</span></span></code></pre></div><p>And write the basic structure of the class and export it as default export:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">// ./lib/FeedbackDelay.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline;">FeedbackDelay</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">  constructor</span><span style="color:#F8F8F2;">() {</span></span>
<span class="line"><span style="color:#F8F8F2;">    console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;FeedbackDelay created!&#39;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">export</span><span style="color:#F92672;"> default</span><span style="color:#F8F8F2;"> FeedbackDelay;</span></span></code></pre></div><p>Then, let&#39;s import our newly created <code>FeedbackDelay</code> class into the <code>main.js</code> file and create a new instance to check that everything works as expected:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">// main.js</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> resumeAudioContext </span><span style="color:#F92672;">from</span><span style="color:#E6DB74;"> &#39;./lib/resume-audio-context.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> loadAudioBuffer </span><span style="color:#F92672;">from</span><span style="color:#E6DB74;"> &#39;./lib/load-audio-buffer.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line highlighted"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> FeedbackDelay </span><span style="color:#F92672;">from</span><span style="color:#E6DB74;"> &#39;./lib/FeedbackDelay.js&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> audioContext </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> new</span><span style="color:#A6E22E;"> AudioContext</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F92672;">await</span><span style="color:#A6E22E;"> resumeAudioContext</span><span style="color:#F8F8F2;">(audioContext);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> buffer </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> await</span><span style="color:#A6E22E;"> loadAudioBuffer</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;./assets/sample.wav&#39;</span><span style="color:#F8F8F2;">, audioContext.sampleRate);</span></span>
<span class="line highlighted"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> delay </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> new</span><span style="color:#A6E22E;"> FeedbackDelay</span><span style="color:#F8F8F2;">();</span></span></code></pre></div><p>If you reload the page, you should see the log appear from the <code>FeedbackDelay</code> constructor in the console:</p><p><img src="/webaudio-tutorials/assets/instance-created.Bw3bzOAh.png" alt="instance-created"></p><p>Before going into the implementation of the actual audio graph of the delay, we can already see an issue with our code. Our feedback delay will very probably have to create some nodes to process the audio stream, but our <code>AudioContext</code> only lives in the <code>main.js</code> &quot;context&quot;.</p><p>To fix this, let&#39;s modify our <code>FeedbackDelay</code> constructor so that we can pass a resumed <code>AudioContext</code> when we instantiate it. While we are here, let&#39;s also pass it an object as second argument that will allow us to configure it later:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff vp-code"><code><span class="line"><span style="color:#88846F;">// ./lib/FeedbackDelay.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline;">FeedbackDelay</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line diff remove"><span style="color:#66D9EF;font-style:italic;">  constructor</span><span style="color:#F8F8F2;">() </span></span>
<span class="line diff add"><span style="color:#66D9EF;font-style:italic;">  constructor</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">audioContext</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">options</span><span style="color:#F92672;"> =</span><span style="color:#F8F8F2;"> {}) </span></span>
<span class="line"><span style="color:#F8F8F2;">  { </span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">    console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;FeedbackDelay created!&#39;</span><span style="color:#F8F8F2;">); </span></span>
<span class="line diff add"><span style="color:#88846F;">    // store the audioContext instance inside the FeedbackDelay instance</span></span>
<span class="line diff add"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.audioContext </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext; </span></span>
<span class="line diff add"><span style="color:#88846F;">    // prepare logic for handling configuration options</span></span>
<span class="line diff add"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.options </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> Object.</span><span style="color:#A6E22E;">assign</span><span style="color:#F8F8F2;">({}, options); </span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff vp-code"><code><span class="line"><span style="color:#88846F;">// main.js</span></span>
<span class="line diff remove"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> delay </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> new</span><span style="color:#A6E22E;"> FeedbackDelay</span><span style="color:#F8F8F2;">(); </span></span>
<span class="line diff add"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> delay </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> new</span><span style="color:#A6E22E;"> FeedbackDelay</span><span style="color:#F8F8F2;">(audioContext, {}); </span></span></code></pre></div><h2 id="connecting-to-the-audio-graph" tabindex="-1">Connecting to the audio graph <a class="header-anchor" href="#connecting-to-the-audio-graph" aria-label="Permalink to &quot;Connecting to the audio graph&quot;">​</a></h2><p>So far so good, we have our <code>FeedbackDelay</code> instance created, but it is not yet inserted into our audio graph. Indeed, for now our <code>AudioBufferSourceNode</code> is directly connected to the <code>destination</code>, while we would like to connect it to our delay, which itself should be connected to the destination, such as:</p><p><img src="/webaudio-tutorials/assets/graph-outer.DlayBEBx.png" alt="graph-outer"></p><p>As our <code>FeedbackDelay</code> is not a full featured native <code>AudioNode</code>, let&#39;s consider it will expose two <code>AudioNode</code> attributes, which we will be called <code>input</code> and <code>output</code>, to which native <code>AudioNode</code> can connect, or on which they can be connected.</p><p>So, let&#39;s start by modifying our <code>main.js</code> file to insert our feedback delay between the source and the destination:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff vp-code"><code><span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> buffer </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> await</span><span style="color:#A6E22E;"> loadAudioBuffer</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">&#39;./assets/sample.wav&#39;</span><span style="color:#F8F8F2;">, audioContext.sampleRate);</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">const</span><span style="color:#F8F8F2;"> delay </span><span style="color:#F92672;">=</span><span style="color:#F92672;"> new</span><span style="color:#A6E22E;"> FeedbackDelay</span><span style="color:#F8F8F2;">(audioContext, {});</span></span>
<span class="line diff add"><span style="color:#F8F8F2;">delay.output.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(audioContext.destination); </span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6E22E;">setInterval</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;font-style:italic;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> src </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext.</span><span style="color:#A6E22E;">createBufferSource</span><span style="color:#F8F8F2;">();</span></span>
<span class="line diff remove"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(audioContext.destination); </span></span>
<span class="line diff add"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(delay.input); </span></span>
<span class="line"><span style="color:#F8F8F2;">    src.buffer </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> buffer;</span></span>
<span class="line"><span style="color:#F8F8F2;">    src.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">();</span></span>
<span class="line"><span style="color:#F8F8F2;">}, </span><span style="color:#AE81FF;">1000</span><span style="color:#F8F8F2;">);</span></span></code></pre></div><p>Of course if you try to reload now, you will run into the following error</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki monokai vp-code"><code><span class="line"><span>Uncaught TypeError: Cannot read properties of undefined (reading &#39;connect&#39;)</span></span></code></pre></div><p>Indeed, the line:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">// main.js</span></span>
<span class="line"><span style="color:#F8F8F2;">delay.output.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(audioContext.destination);</span></span></code></pre></div><p>tries to call some <code>connect</code> method on something that is not defined into our <code>FeedbackDelay</code> class. So let&#39;s fix this issue, by creating the <code>input</code> and <code>output</code> nodes of our <code>FeedbackDelay</code>:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai has-diff vp-code"><code><span class="line"><span style="color:#88846F;">// ./lib/FeedbackDelay.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline;">FeedbackDelay</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">  constructor</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">audioContext</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">options</span><span style="color:#F92672;"> =</span><span style="color:#F8F8F2;"> {}) {</span></span>
<span class="line"><span style="color:#88846F;">    // store the audioContext instance inside the FeedbackDelay instance</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.audioContext </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext;</span></span>
<span class="line"><span style="color:#88846F;">    // prepare logic for handling configuration options</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.options </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> Object.</span><span style="color:#A6E22E;">assign</span><span style="color:#F8F8F2;">({}, options);</span></span>
<span class="line"></span>
<span class="line diff add"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.input </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createGain</span><span style="color:#F8F8F2;">(); </span></span>
<span class="line diff add"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.output </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createGain</span><span style="color:#F8F8F2;">(); </span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div><p>OK, now that our <code>FeedbackDelay</code> expose an <code>input</code> and an <code>output</code> attribute, which are both <code>AudioNode</code>, the code should not complain anymore. Then, if you reload your page, you should see that all errors disappeared.</p><p>But all sound as well... This is because inside our <code>FeedbackDelay</code> class the <code>input</code> and <code>output</code> are not connected together. Let&#39;s fix that with implementing our feedback delay for good.</p><h2 id="implement-the-internal-audio-graph" tabindex="-1">Implement the internal audio graph <a class="header-anchor" href="#implement-the-internal-audio-graph" aria-label="Permalink to &quot;Implement the internal audio graph&quot;">​</a></h2><p>The internal graph of our <code>FeedbackDelay</code> will look like the following, with direct connection between the input and output to propagate the direct signal, and branch containing the delay itself with its feedback loop.</p><p><img src="/webaudio-tutorials/assets/graph-inner.BkbVi4Js.png" alt="graph-inner"></p><p>Let&#39;s thus implement this graph into our <code>FeedbackDelay</code> class:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">// ./lib/FeedbackDelay.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline;">FeedbackDelay</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">  constructor</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">audioContext</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">options</span><span style="color:#F92672;"> =</span><span style="color:#F8F8F2;"> {}) {</span></span>
<span class="line"><span style="color:#88846F;">    // store the audioContext instance inside the FeedbackDelay instance</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.audioContext </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> audioContext;</span></span>
<span class="line"><span style="color:#88846F;">    // define default parameter values that can be overriden with options</span></span>
<span class="line"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.options </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> Object.</span><span style="color:#A6E22E;">assign</span><span style="color:#F8F8F2;">({</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">      preGain: </span><span style="color:#AE81FF;">0.7</span><span style="color:#F8F8F2;">,</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">      delayTime: </span><span style="color:#AE81FF;">0.2</span><span style="color:#F8F8F2;">,</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">      feedback: </span><span style="color:#AE81FF;">0.8</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">    }, options);</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#88846F;">    /* Setup audio nodes */</span></span>
<span class="line highlighted"><span style="color:#88846F;">    // input / ouput node</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.input </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createGain</span><span style="color:#F8F8F2;">();</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.output </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createGain</span><span style="color:#F8F8F2;">();</span></span>
<span class="line highlighted"><span style="color:#88846F;">    // feedback loop nodes</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.preGain </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createGain</span><span style="color:#F8F8F2;">();</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.preGain.gain.value </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.options.preGain;</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">    </span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.delay </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createDelay</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">); </span><span style="color:#88846F;">// &quot;1&quot; is the maximum delay time</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.delay.delayTime.value </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.options.delayTime;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.feedback </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.</span><span style="color:#A6E22E;">createGain</span><span style="color:#F8F8F2;">();</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.feedback.gain.value </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.options.feedback;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#88846F;">    /* Setup connections */</span></span>
<span class="line highlighted"><span style="color:#88846F;">    // direct signal</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.input.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.output);</span></span>
<span class="line highlighted"><span style="color:#88846F;">    // direct delay line</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.input.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.preGain);</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.preGain.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.delay);</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.delay.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.output);</span></span>
<span class="line highlighted"><span style="color:#88846F;">    // feedback loop</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.delay.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.feedback);</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.feedback.</span><span style="color:#A6E22E;">connect</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">this</span><span style="color:#F8F8F2;">.delay);</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F92672;">export</span><span style="color:#F92672;"> default</span><span style="color:#F8F8F2;"> FeedbackDelay;</span></span></code></pre></div><p>Tada! I you reload now, you will be able to ear the feedback delay line in action:</p><audio controls loop src="/webaudio-tutorials/static-assets/feedback-delay-full.m4a"></audio><div class="info custom-block"><p class="custom-block-title">INFO</p><p>You can hear that the overlap between the delay line and a new triggering of a source is not very clean, while it should be as we trigger a new sound every 1 sec and our <code>delayTime</code> is 0.2 sec. This is due to how we trigger our source. Indeed using <code>setInterval</code> as we did in first step is generally not a good idea in audio applications as this timer is not precise enough. In the next tutorials we will learn how to overcome such timing issues.</p></div><h2 id="user-interface" tabindex="-1">User interface <a class="header-anchor" href="#user-interface" aria-label="Permalink to &quot;User interface&quot;">​</a></h2><p>Before concluding this tutorial, let&#39;s add some graphical user interface (GUI) to control our feedback delay parameters.</p><p>First, let&#39;s add new methods to our <code>FeedbackDelay</code> class, which will allow us to simply update some of its parameters from the <code>main.js</code> code:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">// ./lib/FeedbackDelay.js</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">class</span><span> </span><span style="color:#A6E22E;text-decoration:underline;">FeedbackDelay</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#66D9EF;font-style:italic;">  constructor</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">audioContext</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;font-style:italic;">options</span><span style="color:#F92672;"> =</span><span style="color:#F8F8F2;"> {}) {</span></span>
<span class="line"><span style="color:#88846F;">    // ...</span></span>
<span class="line"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="color:#A6E22E;">  setPreGain</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">value</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line highlighted"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> timeConstant </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 0.01</span><span style="color:#F8F8F2;">;</span></span>
<span class="line highlighted"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> currentTime </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.currentTime;</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.preGain.gain.</span><span style="color:#A6E22E;">setTargetAtTime</span><span style="color:#F8F8F2;">(value, currentTime, timeConstant);</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#A6E22E;">  setFeedback</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">value</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line highlighted"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> timeConstant </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 0.01</span><span style="color:#F8F8F2;">;</span></span>
<span class="line highlighted"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> currentTime </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.currentTime;</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.feedback.gain.</span><span style="color:#A6E22E;">setTargetAtTime</span><span style="color:#F8F8F2;">(value, currentTime, timeConstant);</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  }</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="color:#A6E22E;">  setDelayTime</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;font-style:italic;">value</span><span style="color:#F8F8F2;">) {</span></span>
<span class="line highlighted"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> timeConstant </span><span style="color:#F92672;">=</span><span style="color:#AE81FF;"> 0.01</span><span style="color:#F8F8F2;">;</span></span>
<span class="line highlighted"><span style="color:#66D9EF;font-style:italic;">    const</span><span style="color:#F8F8F2;"> currentTime </span><span style="color:#F92672;">=</span><span style="color:#FD971F;"> this</span><span style="color:#F8F8F2;">.audioContext.currentTime;</span></span>
<span class="line highlighted"><span style="color:#FD971F;">    this</span><span style="color:#F8F8F2;">.delay.delayTime.</span><span style="color:#A6E22E;">setTargetAtTime</span><span style="color:#F8F8F2;">(value, currentTime, timeConstant);</span></span>
<span class="line highlighted"><span style="color:#F8F8F2;">  }</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>As you can see, this time we used the <a href="https://developer.mozilla.org/en-US/docs/Web/API/AudioParam/setTargetAtTime" target="_blank" rel="noreferrer"><code>setTargetAtTime</code></a> automation method of the <code>AudioParam</code> we want to update. Indeed, using this automation method, instead of <code>param.value = newValue</code> as we did until now, will protect us from discontinuities in the computation of the audio signal, preventing all sorts of click and pops.</p></div><p>Now that everything is ready in our <code>FeedbackDelay</code> class, let&#39;s just create our user interface:</p><div class="language-js"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki monokai vp-code"><code><span class="line"><span style="color:#88846F;">// main.js</span></span>
<span class="line"><span style="color:#A6E22E;">render</span><span style="color:#F8F8F2;">(</span><span style="color:#A6E22E;">html</span><span style="color:#E6DB74;">`</span></span>
<span class="line"><span style="color:#E6DB74;">  &lt;h1&gt;04-feedback-delay&lt;/h1&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;div&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-text&gt;preGain&lt;/sc-text&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-slider</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      value=</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">delay.options.preGain</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      @input=</span><span style="color:#F92672;">${</span><span style="color:#FD971F;font-style:italic;">e</span><span style="color:#66D9EF;font-style:italic;"> =&gt;</span><span style="color:#F8F8F2;"> delay.</span><span style="color:#A6E22E;">setPreGain</span><span style="color:#F8F8F2;">(e.detail.value)</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &gt;&lt;/sc-slider&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;/div&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;div&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-text&gt;feedback&lt;/sc-text&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-slider</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      value=</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">delay.options.feedback</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      @input=</span><span style="color:#F92672;">${</span><span style="color:#FD971F;font-style:italic;">e</span><span style="color:#66D9EF;font-style:italic;"> =&gt;</span><span style="color:#F8F8F2;"> delay.</span><span style="color:#A6E22E;">setFeedback</span><span style="color:#F8F8F2;">(e.detail.value)</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &gt;&lt;/sc-slider&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;/div&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;div&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-text&gt;delayTime&lt;/sc-text&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &lt;sc-slider</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      value=</span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">delay.options.delayTime</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">      @input=</span><span style="color:#F92672;">${</span><span style="color:#FD971F;font-style:italic;">e</span><span style="color:#66D9EF;font-style:italic;"> =&gt;</span><span style="color:#F8F8F2;"> delay.</span><span style="color:#A6E22E;">setDelayTime</span><span style="color:#F8F8F2;">(e.detail.value)</span><span style="color:#F92672;">}</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">    &gt;&lt;/sc-slider&gt;</span></span>
<span class="line highlighted"><span style="color:#E6DB74;">  &lt;/div&gt;</span></span>
<span class="line"><span style="color:#E6DB74;">`</span><span style="color:#F8F8F2;">, document.body);</span></span></code></pre></div><p>And done! If you reload your page, you should now see the interface and should be able to play with the parameters of your feedback delay:</p><p><img src="/webaudio-tutorials/assets/gui.CCAQDNh-.png" alt="gui"></p><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;Conclusion&quot;">​</a></h2><p>In this tutorial, you have created an abstract and reusable audio effect using JavaScript classes and modules. With such pattern, you can envision reusing this effect in another project very easily by just copy / paste the file and importing it, or even start creating your own library of audio effects!</p><p>In the next tutorials, we will focus on how to fix the issue we have seen with inaccuracy of the <code>setInterval</code> during this tutorial. Properly understand this timing issue and how to fix them is a key element to build more advanced synthesis methods and audio applications.</p></div></div></main><footer class="VPDocFooter" data-v-e6f2a212 data-v-b77f9094><!--[--><!--]--><!----><nav class="prev-next" data-v-b77f9094><div class="pager" data-v-b77f9094><a class="VPLink link pager-link prev" href="/webaudio-tutorials/basics/encapsulating-logic.html" data-v-b77f9094><!--[--><span class="desc" data-v-b77f9094>Previous page</span><span class="title" data-v-b77f9094>Encapsulating logic</span><!--]--></a></div><div class="pager" data-v-b77f9094><a class="VPLink link pager-link next" href="/webaudio-tutorials/scheduling/timing-and-scheduling.html" data-v-b77f9094><!--[--><span class="desc" data-v-b77f9094>Next page</span><span class="title" data-v-b77f9094>Timing and Scheduling</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"basics_encapsulating-logic.md\":\"B02WJp0E\",\"scheduling_step-sequencer.md\":\"BLR4AqBr\",\"first-steps_setting-up-environment.md\":\"DGEXyCmx\",\"first-steps_simple-website.md\":\"KdmdrSWl\",\"basics_amplitude-modulation-synthesis.md\":\"BV8LBI9Z\",\"first-steps_generalities.md\":\"BdbxhhUB\",\"index.md\":\"Cnpzc8jN\",\"basics_reusable-feedback-delay.md\":\"ChVEG-Cp\",\"scheduling_granular-synthesis.md\":\"DIRpu14j\",\"basics_web-audio-api-introduction.md\":\"CycO03f_\",\"basics_oscillators-and-audio-files.md\":\"Dy3lr_11\",\"scheduling_timing-and-scheduling.md\":\"FtPHhkuX\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Web Audio Tutorials\",\"description\":\"Set of tutorials on the Web Audio API\",\"base\":\"/webaudio-tutorials/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"}],\"sidebar\":[{\"text\":\"Introduction\",\"link\":\"/\"},{\"text\":\"First steps\",\"items\":[{\"text\":\"Generalities about the Web\",\"link\":\"/first-steps/generalities.md\"},{\"text\":\"Setting up an environment\",\"link\":\"/first-steps/setting-up-environment.md\"},{\"text\":\"Create a simple website\",\"link\":\"/first-steps/simple-website.md\"}]},{\"text\":\"Basics\",\"items\":[{\"text\":\"Web Audio API - Introduction\",\"link\":\"/basics/web-audio-api-introduction.md\"},{\"text\":\"Oscillators and audio files\",\"link\":\"/basics/oscillators-and-audio-files.md\"},{\"text\":\"Ampliture modulation\",\"link\":\"/basics/amplitude-modulation-synthesis.md\"},{\"text\":\"Encapsulating logic\",\"link\":\"/basics/encapsulating-logic.md\"},{\"text\":\"Reusable feedback delay\",\"link\":\"/basics/reusable-feedback-delay.md\"}]},{\"text\":\"Scheduling\",\"items\":[{\"text\":\"Timing and Scheduling\",\"link\":\"/scheduling/timing-and-scheduling.md\"},{\"text\":\"Granular Synthesis\",\"link\":\"/scheduling/granular-synthesis.md\"},{\"text\":\"Step Sequencer\",\"link\":\"/scheduling/step-sequencer.md\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/ircam-ismm/webaudio-tutorials\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>